<UserControl x:Class="SmartAlloc.Views.GoalsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:SmartAlloc.ViewModels"
             xmlns:svc="clr-namespace:SmartAlloc.Services"
             Background="{DynamicResource BackgroundBrush}">

    <ScrollViewer Style="{StaticResource ScrollViewerStyle}">
        <Grid Margin="28,20,28,28">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <StackPanel Grid.Row="0" Margin="0,0,0,4">
                <TextBlock Text="{Binding [Title.Goals], Source={StaticResource Loc}}" Style="{StaticResource PageTitleStyle}"/>
                <TextBlock Text="{Binding [Title.GoalsSub], Source={StaticResource Loc}}" Style="{StaticResource PageSubtitleStyle}"/>
            </StackPanel>

            <ItemsControl Grid.Row="1" ItemsSource="{Binding HabitAlerts}"
                          Margin="0,0,0,16"
                          Visibility="{Binding ShowHabitAlerts, Converter={StaticResource BoolToVisConverter}}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:HabitAlert}">
                        <Border CornerRadius="10" Padding="14,10" Margin="0,0,0,6"
                                Background="#19F39C12" BorderBrush="#40F39C12" BorderThickness="1">
                            <StackPanel>
                                <TextBlock Text="{Binding Message}" FontSize="12"
                                           Foreground="#F39C12" FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding ImpactHint}" FontSize="11"
                                           Foreground="{DynamicResource TextMutedBrush}"
                                           Margin="0,3,0,0" TextWrapping="Wrap"
                                           Visibility="{Binding ImpactHint,
                                               Converter={StaticResource StringToVisConverter}}"/>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <Grid Grid.Row="2" Margin="0,0,0,16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Button Grid.Column="0" Content="{Binding [Btn.Back], Source={StaticResource Loc}}"
                        Command="{Binding BackToYearViewCommand}"
                        Padding="12,8" Margin="0,0,12,0">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource OutlineButtonStyle}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsMonthView}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button Grid.Column="1" Content="◀"
                        Command="{Binding PreviousYearCommand}"
                        Width="36" Padding="4,8">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource OutlineButtonStyle}">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsMonthView}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
                <TextBlock Grid.Column="2" FontSize="20" FontWeight="Bold"
                           Foreground="{DynamicResource TextPrimaryBrush}"
                           HorizontalAlignment="Center" VerticalAlignment="Center">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Text" Value="{Binding YearLabel}"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsMonthView}" Value="True">
                                    <Setter Property="Text" Value="{Binding MonthLabel}"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
                <Button Grid.Column="3" Content="▶"
                        Command="{Binding NextYearCommand}"
                        Width="36" Padding="4,8">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource OutlineButtonStyle}">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsMonthView}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
            </Grid>

            <ItemsControl Grid.Row="3" ItemsSource="{Binding MonthCells}" Margin="0,0,0,20">
                <ItemsControl.Style>
                    <Style TargetType="ItemsControl">
                        <Setter Property="Visibility" Value="Visible"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsMonthView}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ItemsControl.Style>
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <UniformGrid Columns="4" HorizontalAlignment="Stretch"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:MonthCellVM}">
                        <Border Margin="6" Padding="16,14" CornerRadius="14" Cursor="Hand"
                                MouseLeftButtonUp="MonthCell_Click">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Background" Value="{DynamicResource CardBrush}"/>
                                    <Setter Property="BorderThickness" Value="1"/>
                                    <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                                    <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
                                    <Setter Property="RenderTransform">
                                        <Setter.Value>
                                            <ScaleTransform ScaleX="1" ScaleY="1"/>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsCurrent}" Value="True">
                                            <Setter Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                                            <Setter Property="BorderThickness" Value="2"/>
                                        </DataTrigger>
                                        <EventTrigger RoutedEvent="MouseEnter">
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleX"
                                                                     To="1.04" Duration="0:0:0.15">
                                                        <DoubleAnimation.EasingFunction><QuadraticEase EasingMode="EaseOut"/></DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                    <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleY"
                                                                     To="1.04" Duration="0:0:0.15">
                                                        <DoubleAnimation.EasingFunction><QuadraticEase EasingMode="EaseOut"/></DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </EventTrigger>
                                        <EventTrigger RoutedEvent="MouseLeave">
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleX"
                                                                     To="1" Duration="0:0:0.2">
                                                        <DoubleAnimation.EasingFunction><QuadraticEase EasingMode="EaseOut"/></DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                    <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleY"
                                                                     To="1" Duration="0:0:0.2">
                                                        <DoubleAnimation.EasingFunction><QuadraticEase EasingMode="EaseOut"/></DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </EventTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <StackPanel>
                                <TextBlock Text="{Binding MonthName}" FontSize="16" FontWeight="Bold"
                                           Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,6"/>
                                <TextBlock Text="{Binding GoalSummary}" FontSize="11"
                                           Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,6"/>
                                <ItemsControl ItemsSource="{Binding GoalNames}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding}" FontSize="10"
                                                       Foreground="{StaticResource AccentBrush}"
                                                       TextTrimming="CharacterEllipsis" Margin="0,1"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <StackPanel Grid.Row="4">
                <StackPanel.Style>
                    <Style TargetType="StackPanel">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsMonthView}" Value="True">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </StackPanel.Style>

                <Border Style="{StaticResource GlassCardStyle}" Margin="0,0,0,24">
                    <StackPanel>
                        <TextBlock Text="{Binding [Section.NewGoal], Source={StaticResource Loc}}" Style="{StaticResource SectionTitleStyle}"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="80"/>
                                <ColumnDefinition Width="12"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="12"/>
                                <ColumnDefinition Width="140"/>
                                <ColumnDefinition Width="12"/>
                                <ColumnDefinition Width="140"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{Binding [Label.Icon], Source={StaticResource Loc}}" Style="{StaticResource LabelStyle}"/>
                                <ComboBox ItemsSource="{Binding AvailableIcons}"
                                          SelectedItem="{Binding NewIcon}"
                                          Style="{StaticResource DarkComboStyle}"/>
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock Text="{Binding [Label.GoalName], Source={StaticResource Loc}}" Style="{StaticResource LabelStyle}"/>
                                <TextBox Text="{Binding NewName, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource DarkInputStyle}"/>
                            </StackPanel>

                            <StackPanel Grid.Column="4">
                                <TextBlock Text="{Binding Source={x:Static svc:CurrencyDisplayService.Current}, Path=TargetAmountLabel}" Style="{StaticResource LabelStyle}"/>
                                <TextBox Text="{Binding NewTargetAmount, StringFormat={}{0:N2}, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource DarkInputStyle}"/>
                            </StackPanel>

                            <StackPanel Grid.Column="6">
                                <TextBlock Text="{Binding Source={x:Static svc:CurrencyDisplayService.Current}, Path=InitialAmountLabel}" Style="{StaticResource LabelStyle}"/>
                                <TextBox Text="{Binding NewCurrentAmount, StringFormat={}{0:N2}, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource DarkInputStyle}"/>
                            </StackPanel>
                        </Grid>

                        <Button Content="{Binding [Btn.CreateGoal], Source={StaticResource Loc}}"
                                Command="{Binding AddGoalCommand}"
                                Style="{StaticResource PrimaryButtonStyle}"
                                HorizontalAlignment="Left"
                                Margin="0,16,0,0"/>
                    </StackPanel>
                </Border>

                <ItemsControl ItemsSource="{Binding FilteredGoalItems}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:GoalItemVM}">
                            <Border Style="{StaticResource GlassCardStyle}"
                                    Width="320" Margin="0,0,16,16"
                                    AllowDrop="True"
                                    MouseMove="GoalCard_MouseMove"
                                    GiveFeedback="GoalCard_GiveFeedback"
                                    DragOver="GoalCard_DragOver"
                                    DragLeave="GoalCard_DragLeave"
                                    Drop="GoalCard_Drop"
                                    Cursor="Hand">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <Grid Grid.Row="0" Margin="0,0,0,12">
                                        <StackPanel Orientation="Horizontal">
                                            <Border Width="40" Height="40" CornerRadius="10"
                                                    Background="{StaticResource PrimaryGradientBrush}"
                                                    Margin="0,0,12,0">
                                                <TextBlock Text="{Binding Goal.Icon}" FontSize="20"
                                                           HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                            <StackPanel VerticalAlignment="Center" MaxWidth="190">
                                                <TextBlock Text="{Binding Goal.Name}"
                                                           FontSize="15" FontWeight="SemiBold"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"/>

                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="{Binding PredictedDateText}"
                                                               FontSize="10" Foreground="{StaticResource AccentBrush}"
                                                               Visibility="{Binding HasPrediction,
                                                                   Converter={StaticResource BoolToVisConverter}}"/>
                                                    <TextBlock FontSize="11"
                                                               Visibility="{Binding HasPrediction,
                                                                   Converter={StaticResource InverseBoolToVisConverter}}">
                                                        <TextBlock.ToolTip>
                                                            <ToolTip Content="{Binding InsufficientDataTooltip}"
                                                                     MaxWidth="300"/>
                                                        </TextBlock.ToolTip>
                                                        <Run Text="{Binding [Label.InsufficientData], Source={StaticResource Loc}, Mode=OneWay}" Foreground="#888"/>
                                                    </TextBlock>
                                                </StackPanel>
                                            </StackPanel>
                                        </StackPanel>
                                        <Button Content="✕"
                                                Command="{Binding DataContext.DeleteGoalCommand,
                                                    RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                CommandParameter="{Binding}"
                                                Background="Transparent" BorderThickness="0"
                                                Foreground="{DynamicResource TextMutedBrush}"
                                                Cursor="Hand" FontSize="12" Padding="4"
                                                HorizontalAlignment="Right" VerticalAlignment="Top"/>
                                    </Grid>

                                    <Grid Grid.Row="1" Margin="0,0,0,6">
                                        <TextBlock Text="{Binding ProgressText}"
                                                   FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Text="{Binding Progress, StringFormat={}{0:N0}%}"
                                                   FontSize="13" FontWeight="Bold" HorizontalAlignment="Right">
                                            <TextBlock.Foreground>
                                                <SolidColorBrush Color="{Binding StatusColor}"/>
                                            </TextBlock.Foreground>
                                        </TextBlock>
                                    </Grid>

                                    <ProgressBar Grid.Row="2"
                                                 Value="{Binding Progress, Mode=OneWay}"
                                                 Maximum="100"
                                                 Style="{StaticResource ProgressBarStyle}"
                                                 Height="10" Margin="0,0,0,12">
                                        <ProgressBar.Foreground>
                                            <SolidColorBrush Color="{Binding StatusColor}"/>
                                        </ProgressBar.Foreground>
                                    </ProgressBar>

                                    <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="0,0,0,12">
                                        <TextBlock Text="{Binding [Label.Remaining], Source={StaticResource Loc}}" FontSize="11"
                                                   Foreground="{DynamicResource TextMutedBrush}"/>
                                        <TextBlock FontSize="11" FontWeight="SemiBold"
                                                   Foreground="{StaticResource WarningBrush}">
                                            <TextBlock.Text>
                                                <MultiBinding Converter="{StaticResource MoneyDisplayConverter}">
                                                    <Binding Path="Goal.RemainingAmount"/>
                                                    <Binding Source="{x:Static svc:PrivacyService.Current}" Path="IsPrivate"/>
                                                    <Binding Source="{x:Static svc:CurrencyDisplayService.Current}" Path="SelectedCurrency"/>
                                                </MultiBinding>
                                            </TextBlock.Text>
                                        </TextBlock>
                                    </StackPanel>

                                    <Border Grid.Row="4" Background="{DynamicResource SurfaceBrush}"
                                            CornerRadius="8" Padding="10,8" Margin="0,0,0,10">
                                        <StackPanel>
                                            <TextBlock FontSize="10" FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextMutedBrush}"
                                                       Margin="0,0,0,4">
                                                <Run Text="{Binding [WhatIf.Prefix], Source={StaticResource Loc}, Mode=OneWay}"/>
                                                <Run Text="{Binding WhatIfExtra, StringFormat={}{0:N0}, Mode=OneWay}"/>
                                                <Run Text=" "/>
                                                <Run Text="{Binding Source={x:Static svc:CurrencyDisplayService.Current}, Path=Symbol, Mode=OneWay}"/>
                                                <Run Text="{Binding [WhatIf.PerMonth], Source={StaticResource Loc}, Mode=OneWay}"/>
                                            </TextBlock>
                                            <Slider Value="{Binding WhatIfExtra}"
                                                    Minimum="0" Maximum="{Binding WhatIfMax}"
                                                    TickFrequency="100" IsSnapToTickEnabled="True"
                                                    SmallChange="50" LargeChange="200"
                                                    Foreground="{StaticResource AccentBrush}"
                                                    Margin="0,0,0,4"/>
                                            <TextBlock Text="{Binding WhatIfResult}"
                                                       FontSize="11" Foreground="{StaticResource AccentBrush}"
                                                       TextWrapping="Wrap"/>
                                        </StackPanel>
                                    </Border>

                                    <Grid Grid.Row="5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="8"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBox Grid.Column="0"
                                                 Text="{Binding DepositAmount,
                                                    StringFormat={}{0:N2}, UpdateSourceTrigger=PropertyChanged}"
                                                 Style="{StaticResource DarkInputStyle}"/>
                                        <Button Grid.Column="2"
                                                Content="{Binding [Btn.Deposit], Source={StaticResource Loc}}"
                                                Command="{Binding DataContext.DepositCommand,
                                                    RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                CommandParameter="{Binding}"
                                                Style="{StaticResource SuccessButtonStyle}"
                                                Padding="12,8" FontSize="12"/>
                                    </Grid>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Grid>
    </ScrollViewer>
</UserControl>
